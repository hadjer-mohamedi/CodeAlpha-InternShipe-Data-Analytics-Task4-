{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Task 1: Analyze & Classify Text</h1>

<div class="grid md:grid-cols-3 gap-4 mb-6">
  <div class="col-span-2 bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Top Genres Distribution</h2>
    <canvas id="genreChart" height="160"></canvas>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-medium mb-2">Filters</h3>
    <label class="block text-sm">Sentiment</label>
    <select id="sentimentFilter" class="w-full border rounded px-2 py-1 mb-2">
      <option value="">All</option>
      <option>Positive</option>
      <option>Neutral</option>
      <option>Negative</option>
    </select>
    <label class="block text-sm">Genre</label>
    <select id="genreFilter" class="w-full border rounded px-2 py-1 mb-2">
      <option value="">All</option>
    </select>
    <label class="block text-sm">Min Rating</label>
    <input id="minRating" type="number" step="0.5" value="0" class="w-full border rounded px-2 py-1 mb-2" />
    <label class="block text-sm">Max Rating</label>
    <input id="maxRating" type="number" step="0.5" value="10" class="w-full border rounded px-2 py-1 mb-4" />
    <button id="applyBtn" class="w-full bg-indigo-600 text-white py-2 rounded">Apply Filters</button>
  </div>
</div>

<!-- Chart + Table side by side -->
<div class="grid md:grid-cols-2 gap-4">
  <div class="bg-white rounded shadow p-4">
    <h2 class="font-semibold mb-3">Sample Classified Records</h2>
    <table class="w-full table-auto text-sm" id="resultTable">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-2 text-left">Name</th>
          <th class="p-2">Rating</th>
          <th class="p-2">Sentiment</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <!-- Pagination controls -->
    <div class="flex justify-between items-center mt-3">
      <button id="prevBtn" class="px-3 py-1 bg-slate-200 rounded disabled:opacity-50">Prev</button>
      <span id="pageInfo" class="text-sm text-slate-600"></span>
      <button id="nextBtn" class="px-3 py-1 bg-slate-200 rounded disabled:opacity-50">Next</button>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <canvas id="sentimentChart2" height="220"></canvas>
  </div>
</div>

<script>
  async function populateGenres() {
    const res = await fetch('/api/genres-top?limit=50');
    const rows = await res.json();
    const sel = document.getElementById('genreFilter');
    rows.forEach(r => {
      const opt = document.createElement('option'); opt.value = r.genre; opt.text = r.genre;
      sel.appendChild(opt);
    });
  }

  let chartInstance = null;
  let allRows = []; 
  let currentPage = 1;
  const pageSize = 15;
  let genreChartInstance = null;


  function renderTablePage() {
    const tb = document.getElementById('tableBody');
    tb.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageRows = allRows.slice(start, end);

    pageRows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="p-2">${r.name || ''}</td><td class="p-2 text-center">${r.rating ?? ''}</td>
      <td class="p-2 text-center"><span class="px-2 py-1 rounded text-white ${r.sentiment === 'Positive' ? 'bg-green-600' : r.sentiment === 'Negative' ? 'bg-red-600' : 'bg-amber-500'
        }">${r.sentiment}</span></td>`;
      tb.appendChild(tr);
    });

    // pagination UI
    document.getElementById('pageInfo').textContent =
      `Page ${currentPage} of ${Math.ceil(allRows.length / pageSize)}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= allRows.length;
  }

  async function loadDataAndRender(params = {}) {
    const q = new URLSearchParams(params);
    const res = await fetch('/api/sentiments?' + q.toString());
    allRows = await res.json();
    currentPage = 1;
    renderTablePage();

    // chart distribution
    const counts = { Positive: 0, Neutral: 0, Negative: 0 };
    allRows.forEach(r => counts[r.sentiment] = (counts[r.sentiment] || 0) + 1);
    const labels = Object.keys(counts), data = Object.values(counts);
    const ctx = document.getElementById('sentimentChart2');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: ['#16a34a', '#f59e0b', '#ef4444'] }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }

  document.getElementById('applyBtn').addEventListener('click', () => {
    const sentiment = document.getElementById('sentimentFilter').value;
    const genre = document.getElementById('genreFilter').value;
    const min_rating = document.getElementById('minRating').value || 0;
    const max_rating = document.getElementById('maxRating').value || 10;
    const params = { min_rating, max_rating };
    if (sentiment) params.sentiment = sentiment;
    if (genre) params.genre = genre;
    loadDataAndRender(params);
  });

  async function renderGenreChart() {
    const res = await fetch('/api/genres-top?limit=10');
    const rows = await res.json();
    const labels = rows.map(r => r.genre);
    const data = rows.map(r => r.count);

    const ctx = document.getElementById('genreChart');
    if (genreChartInstance) genreChartInstance.destroy();
    genreChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Anime Count',
          data,
          backgroundColor: '#6366f1'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { autoSkip: false } } }
      }
    });
  }
  // pagination buttons
  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentPage > 1) { currentPage--; renderTablePage(); }
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    if (currentPage * pageSize < allRows.length) { currentPage++; renderTablePage(); }
  });


  renderGenreChart();
  // initial
  populateGenres();
  loadDataAndRender({});
</script>
{% endblock %}