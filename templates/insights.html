{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Task 5: Business Insights</h1>

<!-- Top bar -->
<div class="bg-white rounded shadow p-4 mb-4 flex justify-between items-center">
  <span id="lastUpdated" class="text-xs text-slate-500">Loading...</span>
  <div class="flex gap-2">
    <button id="refreshBtn" class="px-3 py-1 border rounded text-sm bg-indigo-600 text-white">ðŸ”„ Refresh</button>
    <button id="downloadBtn" class="px-3 py-1 border rounded text-sm">â¬‡ Download Report</button>
  </div>
</div>

<!-- Summary cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white p-4 shadow rounded text-center">
    <div class="text-xl font-bold" id="statTotal">--</div>
    <div class="text-xs text-slate-500">Total Anime</div>
  </div>
  <div class="bg-white p-4 shadow rounded text-center">
    <div class="text-xl font-bold" id="statAvgRating">--</div>
    <div class="text-xs text-slate-500">Average Rating</div>
  </div>
  <div class="bg-white p-4 shadow rounded text-center">
    <div class="text-xl font-bold" id="statTopGenre">--</div>
    <div class="text-xs text-slate-500">Top Genre</div>
  </div>
  <div class="bg-white p-4 shadow rounded text-center">
    <div class="text-xl font-bold" id="statPosSent">--</div>
    <div class="text-xs text-slate-500">Positive Sentiment %</div>
  </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-white rounded shadow p-4">
    <h3 class="font-semibold mb-2">Sentiment Distribution</h3>
    <canvas id="sentimentChart" height="200"></canvas>
  </div>
  <div class="bg-white rounded shadow p-4">
    <h3 class="font-semibold mb-2">Emotion Distribution</h3>
    <canvas id="emotionChart" height="200"></canvas>
  </div>
</div>

<div class="bg-white rounded shadow p-4 mb-6">
  <h3 class="font-semibold mb-2">Top Genres</h3>
  <canvas id="genreChart" height="200"></canvas>
</div>

<!-- Report -->
<div class="bg-white rounded shadow p-4">
  <h3 class="font-semibold mb-2">Insights Report</h3>
  <div id="insightsHtml" class="prose max-w-none"></div>
</div>

<div id="loadingOverlay"
  class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow text-center">
    <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-3"></div>
    <p class="text-slate-700">Refreshing data... Please wait.</p>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let charts = {};

  async function loadInsights() {
    const res = await fetch('/api/insights');
    const data = await res.json();
    const md = data.markdown || "No insights generated.";

    // Update cards
    if (data.stats) {
      document.getElementById("statTotal").textContent = data.stats.total_anime || "--";
      document.getElementById("statAvgRating").textContent = (data.stats.avg_rating || 0).toFixed(2);
      document.getElementById("statTopGenre").textContent = data.stats.top_genre || "--";
      document.getElementById("statPosSent").textContent =
        ((data.stats.sentiment_distribution.Positive || 0) * 100).toFixed(1) + "%";
    }

    // Render markdown
    document.getElementById('insightsHtml').innerHTML = marked.parse(md);

    // Last updated
    if (data.last_updated) {
      const dt = new Date(data.last_updated * 1000);
      document.getElementById('lastUpdated').textContent = "Last updated: " + dt.toLocaleString();
    }

    // Download button
    document.getElementById('downloadBtn').onclick = () => {
      const blob = new Blob([md], { type: "text/markdown" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "insights_report.md";
      a.click();
      URL.revokeObjectURL(url);
    };

    // Destroy old charts
    if (charts.sentimentChart) charts.sentimentChart.destroy();
    if (charts.emotionChart) charts.emotionChart.destroy();
    if (charts.genreChart) charts.genreChart.destroy();

    // Sentiment chart
    if (data.sentiments) {
      charts.sentimentChart = new Chart(document.getElementById("sentimentChart"), {
        type: "doughnut",
        data: {
          labels: Object.keys(data.sentiments),
          datasets: [{
            data: Object.values(data.sentiments),
            backgroundColor: ["#16a34a", "#f59e0b", "#ef4444"]
          }]
        }
      });
    }

    // Emotion chart
    if (data.emotions) {
      charts.emotionChart = new Chart(document.getElementById("emotionChart"), {
        type: "bar",
        data: {
          labels: Object.keys(data.emotions),
          datasets: [{
            label: "Count",
            data: Object.values(data.emotions),
            backgroundColor: "#3b82f6"
          }]
        }
      });
    }

    // Genre chart
    if (data.genres) {
      charts.genreChart = new Chart(document.getElementById("genreChart"), {
        type: "bar",
        data: {
          labels: Object.keys(data.genres),
          datasets: [{
            label: "Top Genres",
            data: Object.values(data.genres),
            backgroundColor: "#8b5cf6"
          }]
        },
        options: { indexAxis: 'y' }
      });
    }
  }

  // Poll until insights ready after refresh
  async function checkIfReady() {
    try {
      const res = await fetch("/api/insights");
      const data = await res.json();
      if (data.markdown && !data.markdown.includes("not yet generated")) {
        document.getElementById("loadingOverlay").classList.add("hidden");
        loadInsights();
      } else {
        setTimeout(checkIfReady, 3000);
      }
    } catch {
      setTimeout(checkIfReady, 3000);
    }
  }

  document.getElementById('refreshBtn').onclick = async () => {
    const overlay = document.getElementById("loadingOverlay");
    overlay.classList.remove("hidden");
    overlay.classList.add("flex");

    try {
      // Start refresh
      await fetch("/api/refresh-data", { method: "POST" });

      // Poll until finished
      let done = false;
      while (!done) {
        const res = await fetch("/api/refresh-status");
        const status = await res.json();
        if (status.finished) {
          done = true;
          if (status.error) {
            alert("Error: " + status.error);
          } else {
            await loadInsights();
          }
        } else {
          await new Promise(r => setTimeout(r, 3000)); // wait 3s
        }
      }
    } catch (e) {
      console.error(e);
      alert("Error refreshing data.");
    } finally {
      overlay.classList.add("hidden");
      overlay.classList.remove("flex");
    }
  };

  loadInsights();
</script>
{% endblock %}